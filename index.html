<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EV Charging Log</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      line-height: 1.6;
    }
    label {
      display: block;
      margin-top: 15px;
    }
    input, select, button, textarea {
      padding: 8px;
      margin-top: 5px;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      width: auto;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>บันทึกการชาร์จรถไฟฟ้า</h1>

  <!-- 1. วันที่ -->
  <label for="date">วันที่ชาร์จ:</label>
  <input type="date" id="date" name="date">

  <!-- 2. แอปที่ใช้ชาร์จ -->
  <label for="app">แอปที่ใช้ชาร์จ:</label>
  <select id="app" name="app">
    <option value="">-- เลือกแอป --</option>
    <option>Altervim</option>
    <option>Charge+</option>
    <option>ChargeNow</option>
    <option>ChargeSavvy</option>
    <option>EA Anywhere</option>
    <option>EleX by EGAT</option>
    <option>EV Station PluZ</option>
    <option>Evolt</option>
    <option>MEA EV</option>
    <option>PEA VOLTA</option>
    <option>SHARGE</option>
    <option>Spark</option>
  </select>

  <!-- 3. สถานที่ตั้ง -->
  <label for="location">สถานที่ตั้ง:</label>
  <input type="text" id="location" name="location" placeholder="ชื่อสถานที่">
  <button type="button" onclick="getLocation()">แนบพิกัด GPS</button>
  <p id="coordsDisplay"></p>

  <!-- 4. จังหวัด -->
  <label for="province">จังหวัด:</label>
  <select id="province" name="province">
    <option value="">-- เลือกจังหวัด --</option>
  </select>
  <button type="button" onclick="reverseGeocode()">ดึงจังหวัดจาก GPS</button>

  <!-- 5. เลขไมล์ -->
  <label for="mileage">เลขไมล์ (กม.):</label>
  <input type="number" id="mileage" name="mileage" min="0" step="1">

  <!-- 6. พลังงานที่ได้รับ -->
  <label for="energy">พลังงานที่ได้รับ (kWh):</label>
  <input type="number" id="energy" name="energy" min="0" step="0.01">

  <!-- 7. ค่าใช้จ่ายรวม -->
  <label for="cost">ค่าใช้จ่ายรวม (บาท):</label>
  <input type="number" id="cost" name="cost" min="0" step="0.01" onblur="formatDecimal(this)">

  <!-- 8. หมายเหตุ -->
  <label for="note">หมายเหตุ:</label>
  <textarea id="note" name="note"></textarea>

  <script>
    // 1. GPS & พิกัด
    let lat = null, lon = null;

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            lat = pos.coords.latitude.toFixed(6);
            lon = pos.coords.longitude.toFixed(6);
            document.getElementById("coordsDisplay").innerText = `ละติจูด: ${lat}, ลองจิจูด: ${lon}`;
          },
          (err) => alert("ไม่สามารถเข้าถึงพิกัดได้: " + err.message)
        );
      } else {
        alert("เบราว์เซอร์ของคุณไม่รองรับการใช้ GPS");
      }
    }

    // 2. ดึงจังหวัดจากพิกัดด้วย Nominatim
    function reverseGeocode() {
      if (!lat || !lon) {
        alert("กรุณาแนบพิกัดก่อน");
        return;
      }
      fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
        .then(res => res.json())
        .then(data => {
          const province = data.address.state || data.address.county || "";
          const dropdown = document.getElementById("province");
          for (let option of dropdown.options) {
            if (province.includes(option.value) || option.value.includes(province)) {
              dropdown.value = option.value;
              return;
            }
          }
          alert("ไม่พบจังหวัดที่ตรงกับพิกัด");
        })
        .catch(err => alert("เกิดข้อผิดพลาดในการดึงจังหวัด: " + err));
    }

    // 3. รายชื่อจังหวัดไทย
    const provinces = [
      "กรุงเทพมหานคร", "กระบี่", "กาญจนบุรี", "กาฬสินธุ์", "กำแพงเพชร", "ขอนแก่น", "จันทบุรี",
      "ฉะเชิงเทรา", "ชลบุรี", "ชัยนาท", "ชัยภูมิ", "ชุมพร", "เชียงราย", "เชียงใหม่",
      "ตรัง", "ตราด", "ตาก", "นครนายก", "นครปฐม", "นครพนม", "นครราชสีมา", "นครศรีธรรมราช",
      "นครสวรรค์", "นนทบุรี", "นราธิวาส", "น่าน", "บึงกาฬ", "บุรีรัมย์", "ปทุมธานี", "ประจวบคีรีขันธ์",
      "ปราจีนบุรี", "ปัตตานี", "พระนครศรีอยุธยา", "พะเยา", "พังงา", "พัทลุง", "พิจิตร", "พิษณุโลก",
      "เพชรบุรี", "เพชรบูรณ์", "แพร่", "ภูเก็ต", "มหาสารคาม", "มุกดาหาร", "แม่ฮ่องสอน", "ยโสธร",
      "ยะลา", "ร้อยเอ็ด", "ระนอง", "ระยอง", "ราชบุรี", "ลพบุรี", "ลำปาง", "ลำพูน", "เลย", "ศรีสะเกษ",
      "สกลนคร", "สงขลา", "สตูล", "สมุทรปราการ", "สมุทรสงคราม", "สมุทรสาคร", "สระแก้ว", "สระบุรี",
      "สิงห์บุรี", "สุโขทัย", "สุพรรณบุรี", "สุราษฎร์ธานี", "สุรินทร์", "หนองคาย", "หนองบัวลำภู",
      "อ่างทอง", "อุดรธานี", "อุตรดิตถ์", "อุทัยธานี", "อุบลราชธานี", "อำนาจเจริญ"
    ];
    provinces.sort((a, b) => a === "กรุงเทพมหานคร" ? -1 : b === "กรุงเทพมหานคร" ? 1 : a.localeCompare(b));
    const provinceSelect = document.getElementById("province");
    provinces.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      provinceSelect.appendChild(opt);
    });

    // 4. ใส่ทศนิยมอัตโนมัติ
    function formatDecimal(input) {
      if (input.value && !input.value.includes(".")) {
        input.value = parseFloat(input.value).toFixed(2);
      }
    }
  </script>
</body>
</html>
